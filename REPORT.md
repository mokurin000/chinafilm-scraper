## 程序报告：基于异步爬虫的电影信息抓取与存储

### 一、引言

随着互联网信息的快速发展，海量数据的获取与处理成为各类应用的重要基础。本Python程序旨在从“中国电影”[官方网站](https://www.chinafilm.gov.cn/xxgk/gsxx/dybalx/)异步抓取电影相关信息，并将其结构化存储到Excel文件中。该程序结合了多种先进技术，如异步编程（`asyncio`）、异步HTTP请求（`aiohttp`）、HTML解析（`BeautifulSoup`）、数据缓存（`diskcache`）、数据处理（`polars`）以及日志记录（`loguru`），实现了高效、可靠的数据抓取与处理流程。

### 二、程序结构与功能模块

1. **数据结构定义**：使用`dataclass`定义了`Film`类，包含电影的发行年份、名称、发行单位、导演、备案地和梗概等字段，便于后续的数据组织与处理。

2. **缓存机制**：通过`diskcache`实现了对电影描述信息的本地缓存，避免重复请求，提升程序效率。当请求某个电影详细页面时，首先检查缓存中是否已有对应描述，若有则直接返回，减少网络请求次数。

3. **HTML解析**：
   - **`extract_sub_page`**：从主页面或分页页面中提取子页面链接，利用`BeautifulSoup`解析HTML结构，选取特定的`<a>`标签提取URL。
   - **`extract_page`**：解析具体的电影列表页面，提取每部电影的详细信息如名称、发行单位、导演等，并调用`get_description`获取电影梗概。

4. **异步请求处理**：
   - 使用`aiohttp`的`ClientSession`进行HTTP请求，结合`asyncio`实现异步并发抓取，大幅提升数据获取效率。
   - **`scrape`** 函数首先抓取初始页面，获取所有子页面的URL，并通过`asyncio.gather`并发获取所有分页的子页面链接。

5. **错误处理与日志记录**：借助`loguru`进行日志记录，追踪程序运行状态，记录重要信息和警告，如缺失导演信息的情况。同时，通过异常捕获机制，确保程序在遇到错误或中断（如Ctrl-C）时能够妥善处理。

6. **数据存储**：抓取到的电影数据通过`polars`库转换为数据框，并重命名字段以符合中文语义，最终导出为`films.xlsx` Excel文件，便于后续分析与使用。

### 三、工作流程

1. **初始化**：程序从主页面`index.html`开始，解析出所有子页面的链接。
2. **抓取分页链接**：通过`countPage`变量确定总分页数，异步抓取所有分页页面的URL。
3. **抓取电影详情**：遍历所有页面URL，异步提取每部电影的基本信息，并通过详情链接进一步获取电影梗概。
4. **数据整合与存储**：所有电影信息汇总后，利用`polars`处理并导出为Excel文件。

### 四、设计优势

- **高效性**：通过异步编程与并发请求，显著提升了数据抓取速度。
- **可靠性**：缓存机制减少重复请求，降低网络负担；日志记录便于监控与调试。
- **结构化数据**：使用`dataclass`和`polars`确保数据的结构化与可操作性。

### 五、总结

本Python程序通过集成多种技术，实现了从“中国电影”官方网站高效、可靠地抓取电影信息并存储的功能。程序结构清晰，模块分明，具备良好的扩展性和维护性。未来可进一步优化错误处理机制，增强程序的健壮性，同时考虑使用更高级的数据存储与处理工具，以应对更大规模的数据需求。